<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaruGod Shop - ร้านค้าออนไลน์</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 25%, #87ceeb 50%, #4682b4 75%, #1e3c72 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            animation: backgroundFlow 20s ease-in-out infinite;
        }

        @keyframes backgroundFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .water-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(173, 216, 230, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(135, 206, 235, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 70%, rgba(70, 130, 180, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 90% 90%, rgba(176, 224, 230, 0.4) 0%, transparent 50%);
            z-index: -2;
            animation: waterFlow 25s linear infinite;
        }

        @keyframes waterFlow {
            0% { transform: translateX(-100px) translateY(-50px) rotate(0deg); }
            25% { transform: translateX(50px) translateY(30px) rotate(90deg); }
            50% { transform: translateX(100px) translateY(-30px) rotate(180deg); }
            75% { transform: translateX(-50px) translateY(50px) rotate(270deg); }
            100% { transform: translateX(-100px) translateY(-50px) rotate(360deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Auth Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 248, 255, 0.95));
            border-radius: 25px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(135, 206, 235, 0.5);
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 2.2em;
            color: #2e86ab;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .modal-subtitle {
            color: #4682b4;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 15px 20px;
            margin: 10px 0;
            border: 2px solid rgba(135, 206, 235, 0.3);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #2e86ab;
            box-shadow: 0 0 15px rgba(46, 134, 171, 0.3);
            transform: translateY(-2px);
        }

        .form-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2e86ab, #4682b4);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .form-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #4682b4, #2e86ab);
        }

        .form-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .form-link {
            color: #2e86ab;
            text-decoration: none;
            cursor: pointer;
            margin: 10px;
            display: inline-block;
            transition: color 0.3s ease;
        }

        .form-link:hover {
            color: #4682b4;
            text-decoration: underline;
        }

        .error-message, .success-message {
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
            display: none;
        }

        .error-message {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .success-message {
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 3px solid rgba(135, 206, 235, 0.3);
            position: relative;
            overflow: hidden;
        }

        .logo {
            font-size: 2.8em;
            color: #2e86ab;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            color: #4682b4;
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .user-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
            flex-wrap: wrap;
        }

        .control-btn {
            background: rgba(46, 134, 171, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1em;
            text-decoration: none;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            background: rgba(70, 130, 180, 0.95);
        }

        .user-info {
            background: rgba(40, 167, 69, 0.95);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            font-size: 0.9em;
        }

        .shop-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(15px);
        }

        .shop-section h2 {
            color: #2e86ab;
            margin-bottom: 20px;
            font-size: 2em;
            text-align: center;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .product-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            border: 2px solid rgba(135, 206, 235, 0.3);
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: #6c757d;
            border: 2px dashed #dee2e6;
        }

        .product-name {
            font-size: 1.3em;
            color: #2e86ab;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .product-description {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .product-price {
            font-size: 1.5em;
            color: #28a745;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .product-stock {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .product-stock.low-stock {
            color: #dc3545;
            font-weight: bold;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .quantity-btn {
            background: #2e86ab;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quantity-btn:hover {
            background: #4682b4;
            transform: scale(1.1);
        }

        .quantity-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #2e86ab;
            min-width: 40px;
            text-align: center;
        }

        .buy-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .buy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .buy-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .cart-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .cart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .admin-panel {
            display: none;
        }

        .hidden {
            display: none !important;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-input {
            flex: 1;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .notification.info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }

        .main-content {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .products-grid {
                grid-template-columns: 1fr;
            }

            .user-controls {
                flex-direction: column;
                top: 10px;
                right: 10px;
            }

            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="water-bg"></div>
    
    <!-- Login Modal -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-title">🔐 เข้าสู่ระบบ</div>
            <div class="modal-subtitle">MaruGod Shop</div>
            
            <div id="login-error" class="error-message"></div>
            <div id="login-success" class="success-message"></div>
            
            <input type="email" id="login-email" class="form-input" placeholder="อีเมล" required>
            <input type="password" id="login-password" class="form-input" placeholder="รหัสผ่าน" required>
            
            <button class="form-btn" onclick="userLogin()" id="login-btn">🔐 เข้าสู่ระบบ</button>
            
            <div style="margin-top: 20px;">
                <a class="form-link" onclick="showRegisterModal()">สมัครสมาชิก</a> |
                <a class="form-link" onclick="showForgotPasswordModal()">ลืมรหัสผ่าน?</a> |
                <a class="form-link" onclick="showAdminLoginModal()">เข้าสู่ระบบแอดมิน</a>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal hidden" id="register-modal">
        <div class="modal-content">
            <div class="modal-title">📝 สมัครสมาชิก</div>
            <div class="modal-subtitle">MaruGod Shop</div>
            
            <div id="register-error" class="error-message"></div>
            <div id="register-success" class="success-message"></div>
            
            <div class="form-row">
                <input type="text" id="register-firstname" class="form-input" placeholder="ชื่อจริง" required>
                <input type="text" id="register-lastname" class="form-input" placeholder="นามสกุล" required>
            </div>
            
            <input type="text" id="register-username" class="form-input" placeholder="ชื่อผู้ใช้" required>
            <input type="email" id="register-email" class="form-input" placeholder="อีเมล" required>
            <input type="tel" id="register-phone" class="form-input" placeholder="เบอร์โทรศัพท์" required>
            <input type="password" id="register-password" class="form-input" placeholder="รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)" required>
            <input type="password" id="register-confirm-password" class="form-input" placeholder="ยืนยันรหัสผ่าน" required>
            
            <textarea id="register-address" class="form-textarea" placeholder="ที่อยู่สำหรับจัดส่งสินค้า" required></textarea>
            
            <button class="form-btn" onclick="userRegister()" id="register-btn">📝 สมัครสมาชิก</button>
            
            <div style="margin-top: 20px;">
                <a class="form-link" onclick="showLoginModal()">มีบัญชีแล้ว? เข้าสู่ระบบ</a>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal hidden" id="forgot-password-modal">
        <div class="modal-content">
            <div class="modal-title">🔑 ลืมรหัสผ่าน</div>
            <div class="modal-subtitle">กรุณากรอกอีเมลเพื่อรีเซ็ตรหัสผ่าน</div>
            
            <div id="forgot-error" class="error-message"></div>
            <div id="forgot-success" class="success-message"></div>
            
            <input type="email" id="forgot-email" class="form-input" placeholder="อีเมล" required>
            
            <button class="form-btn" onclick="sendPasswordReset()" id="forgot-btn">📧 ส่งลิงก์รีเซ็ตรหัสผ่าน</button>
            
            <div style="margin-top: 20px;">
                <a class="form-link" onclick="showLoginModal()">กลับไปเข้าสู่ระบบ</a>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="modal hidden" id="admin-login-modal">
        <div class="modal-content">
            <div class="modal-title">👑 เข้าสู่ระบบแอดมิน</div>
            <div class="modal-subtitle">MaruGod Shop Admin Panel</div>
            
            <div id="admin-login-error" class="error-message"></div>
            
            <input type="text" id="admin-username" class="form-input" placeholder="ชื่อผู้ใช้แอดมิน" required>
            <input type="password" id="admin-password" class="form-input" placeholder="รหัสผ่านแอดมิน" required>
            
            <button class="form-btn" onclick="adminLogin()" id="admin-login-btn">👑 เข้าสู่ระบบแอดมิน</button>
            
            <div style="margin-top: 20px;">
                <a class="form-link" onclick="showLoginModal()">เข้าสู่ระบบผู้ใช้ทั่วไป</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <div class="user-controls">
            <div class="user-info" id="user-info">
                👤 ยินดีต้อนรับ, <span id="username-display"></span>
            </div>
            <button class="control-btn" onclick="logout()">🚪 ออกจากระบบ</button>
        </div>

        <div class="container">
            <header>
                <div class="logo">🌱 MaruGod Shop</div>
                <div class="subtitle">ร้านเกษตรกรรมออนไลน์ที่ดีที่สุด</div>
                <div style="color: #666; margin-top: 10px;">
                    เมล็ดพันธุ์คุณภาพสูง • ปุ๋ยอินทรีย์ • อุปกรณ์การเกษตร
                </div>
            </header>

            <div class="shop-section">
                <h2>🛍️ สินค้าแนะนำ</h2>
                <div class="products-grid" id="products-grid">
                    <!-- Sample Products -->
                    <div class="product-card">
                        <div class="product-image">🌱</div>
                        <div class="product-name">เมล็ดผักกาดหอม</div>
                        <div class="product-description">เมล็ดพันธุ์ผักกาดหอมคุณภาพสูง ให้ผลผลิตดี เหมาะสำหรับการปลูกทั้งในบ้านและไร่</div>
                        <div class="product-price">฿45.00</div>
                        <div class="product-stock">คงเหลือ: 50 ซอง</div>
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="decreaseQuantity(this)">-</button>
                            <span class="quantity-display">1</span>
                            <button class="quantity-btn" onclick="increaseQuantity(this)">+</button>
                        </div>
                        <button class="cart-btn" onclick="addToCart(1)">🛒 เพิ่มลงตะกร้า</button>
                        <button class="buy-btn" onclick="buyNow(1)">🛍️ ซื้อทันที</button>
                    </div>

                    <div class="product-card">
                        <div class="product-image">🌿</div>
                        <div class="product-name">ปุ๋ยอินทรีย์</div>
                        <div class="product-description">ปุ๋ยอินทรีย์ธรรมชาติ 100% ช่วยเสริมความอุดมสมบูรณ์ของดิน</div>
                        <div class="product-price">฿120.00</div>
                        <div class="product-stock">คงเหลือ: 30 ถุง</div>
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="decreaseQuantity(this)">-</button>
                            <span class="quantity-display">1</span>
                            <button class="quantity-btn" onclick="increaseQuantity(this)">+</button>
                        </div>
                        <button class="cart-btn" onclick="addToCart(2)">🛒 เพิ่มลงตะกร้า</button>
                        <button class="buy-btn" onclick="buyNow(2)">🛍️ ซื้อทันที</button>
                    </div>

                    <div class="product-card">
                        <div class="product-image">🥒</div>
                        <div class="product-name">เมล็ดแตงกวา</div>
                        <div class="product-description">เมล็ดแตงกวาพันธุ์ดี เก็บเกี่ยวได้เร็ว รสชาติหวานกรอบ</div>
                        <div class="product-price">฿38.00</div>
                        <div class="product-stock low-stock">คงเหลือ: 8 ซอง</div>
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="decreaseQuantity(this)">-</button>
                            <span class="quantity-display">1</span>
                            <button class="quantity-btn" onclick="increaseQuantity(this)">+</button>
                        </div>
                        <button class="cart-btn" onclick="addToCart(3)">🛒 เพิ่มลงตะกร้า</button>
                        <button class="buy-btn" onclick="buyNow(3)">🛍️ ซื้อทันที</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let isAdmin = false;
        let users = [];
        let cart = [];

        // Mock data for testing
        const mockUsers = [
            {
                id: 1,
                email: 'user@test.com',
                password: '123456',
                firstName: 'ทดสอบ',
                lastName: 'ผู้ใช้',
                username: 'testuser',
                phone: '0801234567',
                address: 'กรุงเทพมหานคร'
            }
        ];

        const mockAdmins = [
            {
                username: 'admin',
                password: 'admin123'
            }
        ];

        // Initialize the application
        function initApp() {
            // Load users from localStorage or use mock data
            const savedUsers = JSON.parse(window.localStorage?.getItem('marugod_users') || 'null');
            users = savedUsers || mockUsers;
            
            // Check if user is already logged in
            const savedUser = JSON.parse(window.localStorage?.getItem('marugod_current_user') || 'null');
            if (savedUser) {
                currentUser = savedUser;
                showMainContent();
            } else {
                showLoginModal();
            }
        }

        // Show/Hide Modals
        function showLoginModal() {
            hideAllModals();
            document.getElementById('login-modal').classList.remove('hidden');
        }

        function showRegisterModal() {
            hideAllModals();
            document.getElementById('register-modal').classList.remove('hidden');
        }

        function showForgotPasswordModal() {
            hideAllModals();
            document.getElementById('forgot-password-modal').classList.remove('hidden');
        }

        function showAdminLoginModal() {
            hideAllModals();
            document.getElementById('admin-login-modal').classList.remove('hidden');
        }

        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.add('hidden');
            });
        }

        function showMainContent() {
            hideAllModals();
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('username-display').textContent = currentUser.firstName + ' ' + currentUser.lastName;
        }

        // Authentication Functions
        function userLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorDiv = document.getElementById('login-error');
            const successDiv = document.getElementById('login-success');

            // Clear previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // Validation
            if (!email || !password) {
                showError('login-error', 'กรุณากรอกอีเมลและรหัสผ่าน');
                return;
            }

            // Find user
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                isAdmin = false;
                
                // Save to localStorage if available
                try {
                    window.localStorage?.setItem('marugod_current_user', JSON.stringify(user));
                } catch (e) {
                    console.log('localStorage not available');
                }
                
                showSuccess('login-success', '
// server.js - MaruGod Shop Backend API
const express = require('express');
const mysql = require('mysql2');
const bcrypt = require('bcrypt');
const jwt = require('jsonwebtoken');
const cors = require('cors');
const dotenv = require('dotenv');

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static('public')); // สำหรับ serve HTML files

// Database Configuration
const db = mysql.createConnection({
    host: process.env.DB_HOST || 'localhost',
    user: process.env.DB_USER || 'root',
    password: process.env.DB_PASSWORD || '',
    database: process.env.DB_NAME || 'marugod_shop'
});

// Connect to Database
db.connect((err) => {
    if (err) {
        console.error('Database connection failed:', err);
        return;
    }
    console.log('Connected to MySQL Database');
});

// Create Tables if not exists
const createTables = () => {
    // Users table
    const createUsersTable = `
        CREATE TABLE IF NOT EXISTS users (
            id INT AUTO_INCREMENT PRIMARY KEY,
            email VARCHAR(255) UNIQUE NOT NULL,
            password VARCHAR(255) NOT NULL,
            firstName VARCHAR(100) NOT NULL,
            lastName VARCHAR(100) NOT NULL,
            username VARCHAR(100) UNIQUE NOT NULL,
            phone VARCHAR(20),
            address TEXT,
            isAdmin BOOLEAN DEFAULT FALSE,
            createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )
    `;

    // Products table
    const createProductsTable = `
        CREATE TABLE IF NOT EXISTS products (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            description TEXT,
            price DECIMAL(10,2) NOT NULL,
            stock INT DEFAULT 0,
            imageUrl VARCHAR(500),
            category VARCHAR(100),
            createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )
    `;

    // Orders table
    const createOrdersTable = `
        CREATE TABLE IF NOT EXISTS orders (
            id INT AUTO_INCREMENT PRIMARY KEY,
            userId INT NOT NULL,
            totalAmount DECIMAL(10,2) NOT NULL,
            status ENUM('pending', 'confirmed', 'shipped', 'delivered', 'cancelled') DEFAULT 'pending',
            shippingAddress TEXT,
            createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (userId) REFERENCES users(id)
        )
    `;

    // Order items table
    const createOrderItemsTable = `
        CREATE TABLE IF NOT EXISTS order_items (
            id INT AUTO_INCREMENT PRIMARY KEY,
            orderId INT NOT NULL,
            productId INT NOT NULL,
            quantity INT NOT NULL,
            price DECIMAL(10,2) NOT NULL,
            FOREIGN KEY (orderId) REFERENCES orders(id),
            FOREIGN KEY (productId) REFERENCES products(id)
        )
    `;

    db.query(createUsersTable, (err) => {
        if (err) console.error('Error creating users table:', err);
    });

    db.query(createProductsTable, (err) => {
        if (err) console.error('Error creating products table:', err);
    });

    db.query(createOrdersTable, (err) => {
        if (err) console.error('Error creating orders table:', err);
    });

    db.query(createOrderItemsTable, (err) => {
        if (err) console.error('Error creating order_items table:', err);
    });
};

createTables();

// JWT Middleware
const authenticateToken = (req, res, next) => {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];

    if (!token) {
        return res.status(401).json({ error: 'Access token required' });
    }

    jwt.verify(token, process.env.JWT_SECRET || 'your-secret-key', (err, user) => {
        if (err) {
            return res.status(403).json({ error: 'Invalid token' });
        }
        req.user = user;
        next();
    });
};

// Admin Middleware
const requireAdmin = (req, res, next) => {
    if (!req.user.isAdmin) {
        return res.status(403).json({ error: 'Admin access required' });
    }
    next();
};

// =============================================================================
// AUTH ROUTES
// =============================================================================

// Register
app.post('/api/register', async (req, res) => {
    try {
        const { email, password, firstName, lastName, username, phone, address } = req.body;

        // Validation
        if (!email || !password || !firstName || !lastName || !username) {
            return res.status(400).json({ error: 'กรุณากรอกข้อมูลให้ครบถ้วน' });
        }

        if (password.length < 6) {
            return res.status(400).json({ error: 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร' });
        }

        // Check if user exists
        db.query('SELECT * FROM users WHERE email = ? OR username = ?', [email, username], async (err, results) => {
            if (err) {
                return res.status(500).json({ error: 'Database error' });
            }

            if (results.length > 0) {
                return res.status(400).json({ error: 'อีเมลหรือชื่อผู้ใช้นี้มีอยู่แล้ว' });
            }

            // Hash password
            const hashedPassword = await bcrypt.hash(password, 10);

            // Insert user
            const insertQuery = 'INSERT INTO users (email, password, firstName, lastName, username, phone, address) VALUES (?, ?, ?, ?, ?, ?, ?)';
            db.query(insertQuery, [email, hashedPassword, firstName, lastName, username, phone, address], (err, result) => {
                if (err) {
                    return res.status(500).json({ error: 'เกิดข้อผิดพลาดในการสมัครสมาชิก' });
                }

                res.status(201).json({ message: 'สมัครสมาชิกสำเร็จ' });
            });
        });
    } catch (error) {
        res.status(500).json({ error: 'Server error' });
    }
});

// Login
app.post('/api/login', (req, res) => {
    try {
        const { email, password } = req.body;

        if (!email || !password) {
            return res.status(400).json({ error: 'กรุณากรอกอีเมลและรหัสผ่าน' });
        }

        db.query('SELECT * FROM users WHERE email = ?', [email], async (err, results) => {
            if (err) {
                return res.status(500).json({ error: 'Database error' });
            }

            if (results.length === 0) {
                return res.status(401).json({ error: 'อีเมลหรือรหัสผ่านไม่ถูกต้อง' });
            }

            const user = results[0];
            const isValidPassword = await bcrypt.compare(password, user.password);

            if (!isValidPassword) {
                return res.status(401).json({ error: 'อีเมลหรือรหัสผ่านไม่ถูกต้อง' });
            }

            // Generate JWT token
            const token = jwt.sign(
                { 
                    id: user.id, 
                    email: user.email, 
                    username: user.username,
                    isAdmin: user.isAdmin 
                },
                process.env.JWT_SECRET || 'your-secret-key',
                { expiresIn: '24h' }
            );

            // Remove password from response
            const { password: _, ...userWithoutPassword } = user;

            res.json({
                message: 'เข้าสู่ระบบสำเร็จ',
                token,
                user: userWithoutPassword
            });
        });
    } catch (error) {
        res.status(500).json({ error: 'Server error' });
    }
});

// Admin Login
app.post('/api/admin-login', (req, res) => {
    try {
        const { username, password } = req.body;

        if (!username || !password) {
            return res.status(400).json({ error: 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน' });
        }

        db.query('SELECT * FROM users WHERE username = ? AND isAdmin = TRUE', [username], async (err, results) => {
            if (err) {
                return res.status(500).json({ error: 'Database error' });
            }

            if (results.length === 0) {
                return res.status(401).json({ error: 'ไม่พบบัญชีแอดมิน' });
            }

            const admin = results[0];
            const isValidPassword = await bcrypt.compare(password, admin.password);

            if (!isValidPassword) {
                return res.status(401).json({ error: 'รหัสผ่านไม่ถูกต้อง' });
            }

            // Generate JWT token
            const token = jwt.sign(
                { 
                    id: admin.id, 
                    email: admin.email, 
                    username: admin.username,
                    isAdmin: true 
                },
                process.env.JWT_SECRET || 'your-secret-key',
                { expiresIn: '24h' }
            );

            // Remove password from response
            const { password: _, ...adminWithoutPassword } = admin;

            res.json({
                message: 'เข้าสู่ระบบแอดมินสำเร็จ',
                token,
                user: adminWithoutPassword
            });
        });
    } catch (error) {
        res.status(500).json({ error: 'Server error' });
    }
});

// =============================================================================
// PRODUCT ROUTES
// =============================================================================

// Get all products
app.get('/api/products', (req, res) => {
    db.query('SELECT * FROM products ORDER BY createdAt DESC', (err, results) => {
        if (err) {
            return res.status(500).json({ error: 'Database error' });
        }
        res.json(results);
    });
});

// Get product by ID
app.get('/api/products/:id', (req, res) => {
    const { id } = req.params;
    
    db.query('SELECT * FROM products WHERE id = ?', [id], (err, results) => {
        if (err) {
            return res.status(500).json({ error: 'Database error' });
        }
        
        if (results.length === 0) {
            return res.status(404).json({ error: 'ไม่พบสินค้า' });
        }
        
        res.json(results[0]);
    });
});

// Add product (Admin only)
app.post('/api/products', authenticateToken, requireAdmin, (req, res) => {
    const { name, description, price, stock, imageUrl, category } = req.body;

    if (!name || !price) {
        return res.status(400).json({ error: 'กรุณากรอกชื่อสินค้าและราคา' });
    }

    const insertQuery = 'INSERT INTO products (name, description, price, stock, imageUrl, category) VALUES (?, ?, ?, ?, ?, ?)';
    db.query(insertQuery, [name, description, price, stock || 0, imageUrl, category], (err, result) => {
        if (err) {
            return res.status(500).json({ error: 'เกิดข้อผิดพลาดในการเพิ่มสินค้า' });
        }

        res.status(201).json({ 
            message: 'เพิ่มสินค้าสำเร็จ', 
            productId: result.insertId 
        });
    });
});

// Update product (Admin only)
app.put('/api/products/:id', authenticateToken, requireAdmin, (req, res) => {
    const { id } = req.params;
    const { name, description, price, stock, imageUrl, category } = req.body;

    const updateQuery = 'UPDATE products SET name = ?, description = ?, price = ?, stock = ?, imageUrl = ?, category = ? WHERE id = ?';
    db.query(updateQuery, [name, description, price, stock, imageUrl, category, id], (err, result) => {
        if (err) {
            return res.status(500).json({ error: 'เกิดข้อผิดพลาดในการอัพเดตสินค้า' });
        }

        if (result.affectedRows === 0) {
            return res.status(404).json({ error: 'ไม่พบสินค้า' });
        }

        res.json({ message: 'อัพเดตสินค้าสำเร็จ' });
    });
});

// Delete product (Admin only)
app.delete('/api/products/:id', authenticateToken, requireAdmin, (req, res) => {
    const { id } = req.params;

    db.query('DELETE FROM products WHERE id = ?', [id], (err, result) => {
        if (err) {
            return res.status(500).json({ error: 'เกิดข้อผิดพลาดในการลบสินค้า' });
        }

        if (result.affectedRows === 0) {
            return res.status(404).json({ error: 'ไม่พบสินค้า' });
        }

        res.json({ message: 'ลบสินค้าสำเร็จ' });
    });
});

// =============================================================================
// ORDER ROUTES
// =============================================================================

// Create order
app.post('/api/orders', authenticateToken, (req, res) => {
    const { items, shippingAddress } = req.body;
    const userId = req.user.id;

    if (!items || items.length === 0) {
        return res.status(400).json({ error: 'กรุณาเลือกสินค้า' });
    }

    // Calculate total amount
    let totalAmount = 0;
    const productChecks = items.map(item => {
        return new Promise((resolve, reject) => {
            db.query('SELECT * FROM products WHERE id = ?', [item.productId], (err, results) => {
                if (err) reject(err);
                if (results.length === 0) reject(new Error('ไม่พบสินค้า'));
                
                const product = results[0];
                if (product.stock < item.quantity) {
                    reject(new Error(`สินค้า ${product.name} เหลือไม่เพียงพอ`));
                }
                
                totalAmount += product.price * item.quantity;
                resolve({ ...item, price: product.price });
            });
        });
    });

    Promise.all(productChecks)
        .then((validatedItems) => {
            // Create order
            const insertOrderQuery = 'INSERT INTO orders (userId, totalAmount, shippingAddress) VALUES (?, ?, ?)';
            db.query(insertOrderQuery, [userId, totalAmount, shippingAddress], (err, orderResult) => {
                if (err) {
                    return res.status(500).json({ error: 'เกิดข้อผิดพลาดในการสร้างคำสั่งซื้อ' });
                }

                const orderId = orderResult.insertId;

                // Insert order items and update product stock
                validatedItems.forEach(item => {
                    // Insert order item
                    const insertItemQuery = 'INSERT INTO order_items (orderId, productId, quantity, price) VALUES (?, ?, ?, ?)';
                    db.query(insertItemQuery, [orderId, item.productId, item.quantity, item.price]);

                    // Update product stock
                    const updateStockQuery = 'UPDATE products SET stock = stock - ? WHERE id = ?';
                    db.query(updateStockQuery, [item.quantity, item.productId]);
                });

                res.status(201).json({ 
                    message: 'สร้างคำสั่งซื้อสำเร็จ', 
                    orderId: orderId,
                    totalAmount: totalAmount
                });
            });
        })
        .catch((error) => {
            res.status(400).json({ error: error.message });
        });
});

// Get user orders
app.get('/api/orders', authenticateToken, (req, res) => {
    const userId = req.user.id;

    const query = `
        SELECT o.*, 
               JSON_ARRAYAGG(
                   JSON_OBJECT(
                       'productId', oi.productId,
                       'quantity', oi.quantity,
                       'price', oi.price,
                       'productName', p.name
                   )
               ) as items
        FROM orders o
        LEFT JOIN order_items oi ON o.id = oi.orderId
        LEFT JOIN products p ON oi.productId = p.id
        WHERE o.userId = ?
        GROUP BY o.id
        ORDER BY o.createdAt DESC
    `;

    db.query(query, [userId], (err, results) => {
        if (err) {
            return res.status(500).json({ error: 'Database error' });
        }
        res.json(results);
    });
});

// Get all orders (Admin only)
app.get('/api/admin/orders', authenticateToken, requireAdmin, (req, res) => {
    const query = `
        SELECT o.*, u.firstName, u.lastName, u.email,
               JSON_ARRAYAGG(
                   JSON_OBJECT(
                       'productId', oi.productId,
                       'quantity', oi.quantity,
                       'price', oi.price,
                       'productName', p.name
                   )
               ) as items
        FROM orders o
        LEFT JOIN users u ON o.userId = u.id
        LEFT JOIN order_items oi ON o.id = oi.orderId
        LEFT JOIN products p ON oi.productId = p.id
        GROUP BY o.id
        ORDER BY o.createdAt DESC
    `;

    db.query(query, (err, results) => {
        if (err) {
            return res.status(500).json({ error: 'Database error' });
        }
        res.json(results);
    });
});

// Update order status (Admin only)
app.put('/api/orders/:id/status', authenticateToken, requireAdmin, (req, res) => {
    const { id } = req.params;
    const { status } = req.body;

    const validStatuses = ['pending', 'confirmed', 'shipped', 'delivered', 'cancelled'];
    if (!validStatuses.includes(status)) {
        return res.status(400).json({ error: 'สถานะไม่ถูกต้อง' });
    }

    db.query('UPDATE orders SET status = ? WHERE id = ?', [status, id], (err, result) => {
        if (err) {
            return res.status(500).json({ error: 'เกิดข้อผิดพลาดในการอัพเดตสถานะ' });
        }

        if (result.affectedRows === 0) {
            return res.status(404).json({ error: 'ไม่พบคำสั่งซื้อ' });
        }

        res.json({ message: 'อัพเดตสถานะสำเร็จ' });
    });
});

// =============================================================================
// USER ROUTES
// =============================================================================

// Get user profile
app.get('/api/profile', authenticateToken, (req, res) => {
    const userId = req.user.id;

    db.query('SELECT id, email, firstName, lastName, username, phone, address, isAdmin FROM users WHERE id = ?', [userId], (err, results) => {
        if (err) {
            return res.status(500).json({ error: 'Database error' });
        }

        if (results.length === 0) {
            return res.status(404).json({ error: 'ไม่พบผู้ใช้' });
        }

        res.json(results[0]);
    });
});

// Update user profile
app.put('/api/profile', authenticateToken, (req, res) => {
    const userId = req.user.id;
    const { firstName, lastName, phone, address } = req.body;

    const updateQuery = 'UPDATE users SET firstName = ?, lastName = ?, phone = ?, address = ? WHERE id = ?';
    db.query(updateQuery, [firstName, lastName, phone, address, userId], (err, result) => {
        if (err) {
            return res.status(500).json({ error: 'เกิดข้อผิดพลาดในการอัพเดตโปรไฟล์' });
        }

        res.json({ message: 'อัพเดตโปรไฟล์สำเร็จ' });
    });
});

// =============================================================================
// SERVE FRONTEND
// =============================================================================

// Serve the main HTML file
app.get('/', (req, res) => {
    res.sendFile(__dirname + '/public/index.html');
});

// Error handling middleware
app.use((err, req, res, next) => {
    console.error(err.stack);
    res.status(500).json({ error: 'Something went wrong!' });
});

// Start server
app.listen(PORT, () => {
    console.log(`MaruGod Shop Server running on port ${PORT}`);
    console.log(`Visit: http://localhost:${PORT}`);
});

module.exports = app;
